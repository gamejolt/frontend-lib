<gj-card class="game-package-card"
	id="game-package-card-{{ $ctrl.package.id }}"
	>

	<div class="game-package-card-pricing"
		ng-class="{ 'game-package-card-pricing-owned': $ctrl.isOwned }"
		>

		<!-- If they own the package -->
		<div ng-if="$ctrl.isOwned">
			<strong>
				OWNED
			</strong>
		</div>

		<!-- If they don't own the package yet. -->
		<div ng-if="!$ctrl.isOwned" ng-switch="::$ctrl.sellable.type">

			<!-- Fixed Pricing -->
			<div ng-switch-when="paid">
				<span class="game-package-card-pricing-sale-percentage"
					ng-if="::$ctrl.sale"
					>
					-{{ ::$ctrl.salePercentageOff }}%
				</span>
				<strong class="game-package-card-pricing-amount">
					{{ ::$ctrl.integer( $ctrl.pricing ) | currency:undefined:0 }}<span class="game-package-card-pricing-decimal">.{{ ::$ctrl.decimal( $ctrl.pricing ) }}</span>
				</strong>
				<span class="game-package-card-pricing-amount game-package-card-pricing-amount-old"
					ng-if="::$ctrl.sale"
					>
					{{ ::$ctrl.integer( $ctrl.saleOldPricing ) | currency:undefined:0 }}<span class="game-package-card-pricing-decimal">.{{ ::$ctrl.decimal( $ctrl.saleOldPricing ) }}</span>
				</span>
				<br><span class="game-package-card-pricing-tag muted">or more</span>
			</div>

			<!-- Pay What You Want -->
			<div ng-switch-when="pwyw">
				<span class="game-package-card-pricing-tag">
					name your price
				</span>
			</div>

			<!-- Free/Default -->
			<div ng-switch-default>
				<strong class="game-package-card-pricing-amount">
					FREE
				</strong>
			</div>
		</div>

	</div>

	<div class="card-title">
		<h4>
			{{ ::($ctrl.package.title || $ctrl.game.title) }}
		</h4>
	</div>

	<div class="card-meta card-meta-sm">

		<!--
			In client, if the game is installed.
		-->
		<span ng-if="$ctrl.localPackage">

			<!-- Reduce number of watches -->
			<span ng-if="$ctrl.localPackage.isInstalling()">
				<span ng-if="!$ctrl.localPackage.isPatchPaused()">
					<span class="tag tag-blue" ng-if="$ctrl.localPackage.isInstalling()" translate>INSTALLING</span>
					<span class="tag tag-pink" ng-if="$ctrl.localPackage.didInstallFail()" translate>INSTALL FAILED</span>
				</span>
				<span ng-if="$ctrl.localPackage.isPatchPaused()">
					<span class="tag" translate>INSTALL PAUSED</span>
				</span>
			</span>
			<span ng-if="$ctrl.localPackage.isUpdating()">
				<span ng-if="!$ctrl.localPackage.isPatchPaused()">
					<span class="tag tag-blue" ng-if="$ctrl.localPackage.isUpdating()" translate>UPDATING</span>
					<span class="tag tag-pink" ng-if="$ctrl.localPackage.didUpdateFail()" translate>UPDATE FAILED</span>
				</span>
				<span ng-if="$ctrl.localPackage.isPatchPaused()">
					<span class="tag" translate>UPDATE PAUSED</span>
				</span>
			</span>
			<span class="tag tag-active" ng-if="$ctrl.localPackage.isSettled() && !$ctrl.localPackage.isRunning()" translate>INSTALLED</span>
			<span class="tag tag-active" ng-if="$ctrl.localPackage.isRunning()" translate>RUNNING</span>
			<span class="tag" ng-if="$ctrl.localPackage.isRemoving()" translate>REMOVING</span>
			<span class="dot-separator"></span>
		</span>

		<span
			ng-repeat="supportKey in ::$ctrl.card.platformSupport"
			ng-class="::'jolticon jolticon-' + $ctrl.card.platformSupportInfo[ supportKey ].icon"
			tooltip="{{ ::$ctrl.card.platformSupportInfo[ supportKey ].tooltip }}"
			>
		</span>

		<span class="dot-separator" ng-if="$ctrl.card.platformSupport.length"></span>

		<span ng-if="$ctrl.card.showcasedRelease">
			<span translate>Version:</span>
			<strong>{{ ::$ctrl.card.showcasedRelease.version_number }}</strong>

			<span class="dot-separator"></span>

			<span am-time-ago="::$ctrl.card.showcasedRelease.published_on"></span>
		</span>
	</div>

	<div class="card-content card-sale-info" ng-if="::$ctrl.sale">
		<strong translate>On sale!</strong>
		<span translate>Offer ends in</span>
		<gj-countdown end="::$ctrl.pricing.end"></gj-countdown>
	</div>

	<div class="card-content" ng-if="::$ctrl.package.description">
		<gj-fade-collapse
			fade-collapse-height="100"
			fade-collapse-is-open="$ctrl.showFullDescription"
			fade-collapse-is-required="$ctrl.canToggleDescription"
			>

			<div ng-bind-html="::$ctrl.package.description | linky"></div>

		</gj-fade-collapse>

		<a class="hidden-text-expander"
			ng-if="::$ctrl.canToggleDescription"
			ng-click="$ctrl.showFullDescription = !$ctrl.showFullDescription"
			gj-track-event="game-package-card:show-full-description"
			></a>
	</div>

	<div ng-if="::!$ctrl.card.showcasedRelease">
		<br>
		<div class="alert alert-warning" translate>
			No published releases yet.
		</div>
	</div>

	<div ng-if="$ctrl.hasPaymentWell">
		<div gj-expand-when="$ctrl.isPaymentOpen" class="payment-well-expander">
			<div class="payment-well">

				<gj-game-package-card-payment-form
					game="::$ctrl.game"
					package="::$ctrl.package"
					sellable="::$ctrl.sellable"
					pricing="::$ctrl.pricing"
					partner-referred-key="::$ctrl.partnerReferredKey"
					partner-referred-by="::$ctrl.partnerReferredBy"
					partner-no-cut="::$ctrl.partnerNoCut"
					on-bought="$ctrl.onPackageBought()"
					>
				</gj-game-package-card-payment-form>

				<div ng-if="::$ctrl.sellable.type == 'pwyw'">
					<hr>
					<span class="jolticon jolticon-chevron-right middle"></span>
					<a class="link-unstyled small"
						ng-click="$ctrl.skipPayment()"
						>
						<span ng-if="::!$ctrl.Environment.isClient" translate>No thanks, take me to the download.</span>
						<span ng-if="::$ctrl.Environment.isClient" translate>No thanks, just install it.</span>
					</a>
				</div>
			</div>
		</div>
	</div>

	<div class="card-controls" ng-if="::$ctrl.card.showcasedRelease">

		<div ng-if="$ctrl.sellable.type != 'paid' || $ctrl.isOwned || $ctrl.isPartner">

			<!--
				The buttons are so different for client that we put them in a child component.
				They will only be available on WTTF since they're pushed in the client component there.'
			-->
			<div ng-if="::$ctrl.Environment.isClient">
				<gj-client-package-card-buttons></gj-client-package-card-buttons>
			</div>

			<div ng-if="::!$ctrl.Environment.isClient">
				<gj-game-package-card-buttons
					[package]="::$ctrl.package"
					[card]="::$ctrl.card"
					(click)="$ctrl.buildClick( $event.build, $event.fromExtraSection )"
					>
				</gj-game-package-card-buttons>
			</div>

			<div ng-if="$ctrl.isPartner && $ctrl.sellable.type == 'paid'">
				<br>
				<div class="alert alert-success">
					<span class="jolticon jolticon-check"></span>
					<span translate>You get access to this package because you're a partner.</span>
				</div>
				<hr>
			</div>

		</div>

		<div ng-if="$ctrl.sellable.type == 'paid' && !$ctrl.isOwned">

			<!--
				Remove this as soon as we open the payment area.
			-->
			<div class="clearfix">
				<button class="btn btn-success-outline btn-block-xs"
					ng-if="!$ctrl.isPaymentOpen"
					ng-click="$ctrl.isPaymentOpen = !$ctrl.isPaymentOpen"
					>
					<span class="jolticon jolticon-heart"></span>
					Buy Now
				</button>

				<span class="game-package-card-payment-what-link">
					(<a class="link-help" ng-click="$ctrl.isWhatOpen = !$ctrl.isWhatOpen" translate>What do you get?</a>)
				</span>
			</div>

		</div>

	</div>

	<div gj-expand-when="$ctrl.isWhatOpen" class="payment-well-expander payment-well-expander-files">
		<div class="payment-well">

			<div ng-repeat="build in $ctrl.builds">

				{{ ::build.primary_file.filename }}
				<small class="text-muted">({{ ::build.primary_file.filesize | filesize }})</small>

				<span ng-repeat="os in ::[ 'windows', 'mac', 'linux', 'other' ]">
					<span
						ng-if="::build[ 'os_' + os ] || build[ 'os_' + os + '_64' ]"
						ng-class="::'jolticon jolticon-' + $ctrl.card.platformSupportInfo[ os ].icon"
						tooltip="{{ ::$ctrl.card.platformSupportInfo[ os ].tooltip }}"
						>
					</span>
				</span>

			</div>

			<br>

			<small translate>And really warm feelings for supporting an indie developer!</small>

		</div>
	</div>

</gj-card>
