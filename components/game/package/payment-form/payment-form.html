<app-form name="gamePackagePayment" ref="form">

	<template v-if="checkoutStep === 'primary'">

		<div class="alert alert-info full-bleed"
			v-if="partner"
			>
			<span v-translate="{ user: partner.display_name }">
				You've accessed this game through a Game Jolt Partner link! A percentage of this sale will go to <b>%{ user }</b>.
			</span>
			<router-link
				class="link-help"
				:to="{ name: 'landing.partners' }"
				target="_blank"
				>
				<translate>Learn more about the Game Jolt Partner system.</translate>
			</router-link>
		</div>

		<p v-if="sellable.type === 'pwyw'">
			<template v-if="!pricing.amount">
				<translate
					:translate-params="{
						developer: game.developer.display_name,
					}"
					>
					Show %{ developer } some love by supporting them!
				</translate>
			</template>
			<template v-else>
				<span v-translate="{ amount: formattedAmount }">
					This developer suggests paying <b>%{ amount }</b>, but you're able to pay what you want!
				</span>
			</template>
		</p>
		<p v-else-if="sellable.type === 'paid'">
			<span v-translate="{ amount: formattedAmount }">
				The developer has set the price of this game to <b>%{ amount }</b>, but you're able to support them by giving more!
			</span>
		</p>

		<div v-if="sellable.type === 'pwyw' && build">
			<a class="small" @click="$emit('skip')">
				<template v-if="operation == 'download'">
					<translate v-if="!GJ_IS_CLIENT">No thanks, take me to the download.</translate>
					<translate v-else>No thanks, just install it.</translate>
				</template>
				<template v-else>
					<translate>No thanks, just play the game.</translate>
				</template>
			</a>
		</div>

		<hr>
	</template>

	<app-loading v-if="!isLoaded" />
	<template v-else>
		<app-loading-fade :is-loading="isProcessing">
			<div
				v-if="checkoutStep === 'primary'"
				:class="{
					'form-horizontal': !Screen.isXs,
					row: Screen.isXs,
				}"
				>

				<app-form-group
					name="amount"
					:label="$gettext( `Name your price` )"
					label-class="col-sm-4"
					>
					<div class="col-sm-8">
						<span class="amount-input">
							<span class="amount-input-currency">$</span>
							<app-form-control
								type="currency"
								step="1"
								:rules="{
									min_value: _minOrderAmount
								}"
								/>
						</span>

						<span
							class="text-muted"
							v-if="sellable.type === 'paid'"
							>
							<translate :translate-params="{ amount: formattedAmount }">
								(%{ amount } or more)
							</translate>
						</span>

						<app-form-control-errors :label="$gettext( `price` )">
							<app-form-control-error
								v-if="sellable.type === 'pwyw'"
								when="min"
								:message="minOrderMessage"
								/>
						</app-form-control-errors>

						<br>

						<p class="small">
							<strong>
								<translate>Support the developer by paying more</translate>
							</strong>
						</p>

						<p>
							<button class="btn btn-success-outline" @click.prevent="addMoney( 1 )">
								+$1
							</button>
							<button class="btn btn-success-outline" @click.prevent="addMoney( 2 )">
								+$2
							</button>
							<button class="btn btn-success-outline" @click.prevent="addMoney( 5 )">
								+$5
							</button>
							<button class="btn btn-success-outline" @click.prevent="addMoney( 10 )">
								+$10
							</button>
						</p>

						<hr>
					</div>
				</app-form-group>

				<app-form-group
					v-if="!app.user"
					name="email_address"
					:label="$gettext( `Email Address:` )"
					label-class="col-sm-4"
					>
					<div class="col-sm-8">
						<app-form-control type="email" />
						<app-form-control-errors
							:label="$gettext( 'email address' )"
							/>
					</div>
				</app-form-group>

				<div class="form-group">
					<label class="col-sm-4 control-label">
						<translate>Checkout with:</translate>
					</label>
					<div class="col-sm-8">

						<!--
							If they have any wallet funds, we try let them checkout with their wallet.
							If they don't have enough funds in their wallet for the order, we give 'em a message.
						-->
						<app-expand :when="valid">
							<div v-if="app.user && walletBalance > 0 && hasSufficientWalletFunds">
								<span
									class="saved-card"
									:class="{ disabled: isLoadingMethods }"
									@click="collectAddress( 'wallet' )"
									>
									<div class="saved-card-avatar">
										<img
											:src="app.user.img_avatar"
											class="img-responsive"
											alt=""
											v-app-tooltip="`${ app.user.display_name } (@${ app.user.username })`"
											>
									</div>
									<div class="saved-card-content">
										<div class="saved-card-label">
											<translate>Your Wallet</translate>
										</div>
										<div class="small">
											<translate>Balance:</translate>
											{{ walletBalance | currency }}

											<span class="text-muted" v-if="walletTax > 0">
												+{{ walletTax | currency }}
												<translate>tax</translate>
											</span>
										</div>
									</div>
								</span>
							</div>

							<template v-if="app.user && cards.length">
								<div class="saved-card-options">
									<div class="saved-card-option">
										<span
											class="saved-card"
											:class="{ disabled: isLoadingMethods }"
											@click="checkoutSavedCard( cards[0] )"
											>
											<div class="saved-card-avatar">
												<img
													class="img-responsive"
													:src="app.user.img_avatar"
													alt=""
													v-app-tooltip="`${ app.user.display_name } (@${ app.user.username })`"
													>
											</div>
											<div class="saved-card-content">
												<div class="saved-card-label">
													<translate>Saved Card</translate>
												</div>
												<span class="tag tag-active">
													{{ cards[0].brand }}
												</span>
												<span class="saved-card-number">
													****
													{{ cards[0].last4 }}
												</span>
												<small class="text-muted" v-if="cardsTax[ cards[0].id ] && cardsTax[ cards[0].id ].amount > 0">
													+{{ cardsTax[ cards[0].id ].amount | currency }}
													<translate>tax</translate>
												</small>
											</div>
										</span>
									</div>

									<span
										class="saved-card-more"
										v-if="cards.length > 1"
										:class="{ disabled: isLoadingMethods }"
										v-app-tooltip="$gettext( 'Select another card' )"
										v-app-popover-trigger="`payment-form-card-selector-${ sellable.id }`"
										>
										<app-jolticon icon="chevron-down" />
									</span>

									<app-popover
										v-if="cards.length > 1"
										:popover-id="'payment-form-card-selector-' + sellable.id"
										position-horizontal="left"
										>
										<div class="list-group list-group-dark">
											<a
												class="list-group-item"
												v-for="card of cards"
												:key="card.id"
												@click="checkoutSavedCard( card )"
												>
												<span class="tag tag-active">
													{{ card.brand }}
												</span>
												****
												{{ card.last4 }}
												<small class="text-muted" v-if="cardsTax[ card.id ] && cardsTax[ card.id ].amount > 0">
													+{{ cardsTax[ card.id ].amount | currency }}
													<translate>tax</translate>
												</small>
											</a>
										</div>
									</app-popover>
								</div>
							</template>
						</app-expand>

						<button
							class="btn btn-outline"
							:disabled="!valid"
							@click.prevent="checkoutCard()"
							>
							<app-jolticon icon="credit-card" />
							<template v-if="cards.length">
								<translate>New Card</translate>
							</template>
							<template v-else>
								<translate>Card</translate>
							</template>
						</button>

						<button
							class="btn btn-outline"
							:disabled="!valid"
							@click.prevent="collectAddress( 'paypal' )"
							>
							<translate>PayPal</translate>
						</button>

					</div>
				</div>
			</div>
			<template v-else-if="checkoutStep === 'address'">

				<div class="alert alert-info full-bleed">
					<app-jolticon icon="info-circle" />
					<translate>Because of international tax laws, we are required to collect this information.</translate>
				</div>

				<div class="row">
					<div class="col-sm-6">
						<app-form-group
							name="country"
							:label="$gettext( 'Country' )"
							>
							<app-form-control-select>
								<option
									v-for="country of countries"
									:key="country.code"
									:value="country.code"
									>
									{{ country.name }}
								</option>
							</app-form-control-select>
							<app-form-control-errors />
						</app-form-group>
					</div>
				</div>

				<app-form-group
					name="street1"
					:label="$gettext( 'Street Address' )"
					>
					<app-form-control type="text" />
					<app-form-control-errors />
				</app-form-group>

				<div class="row">
					<div class="col-sm-6">
						<app-form-group
							name="region"
							:label="$gettext( 'State/Province/County' )"
							>

							<app-form-control
								type="text"
								v-if="!regions"
								:validate-on="['blur']"
								/>

							<app-form-control-select
								v-else
								>
								<option
									v-for="region of regions"
									:key="region.code"
									:value="region.code"
									>
									{{ region.name }}
								</option>
							</app-form-control-select>

							<app-form-control-errors />
						</app-form-group>
					</div>
					<div class="col-sm-6">
						<app-form-group
							name="postcode"
							:label="$gettext( 'Zip/Postal Code' )"
							>
							<app-form-control type="text" />
							<app-form-control-errors />
						</app-form-group>
					</div>
				</div>

				<div class="form-group">

					<!--
						For some reason the tax amount goes on top of this. Gotta manually hoist it on top.
					-->
					<div class="pull-right small" style="position: relative; z-index: 1">
						<a class="link-muted" @click="startOver">
							&laquo;
							<translate>Go back</translate>
						</a>
					</div>

					<div v-if="checkoutType === 'paypal'">
						<button
							class="btn btn-success-outline"
							:disabled="!valid"
							@click.prevent="checkoutPaypal"
							>
							<translate>Proceed to PayPal</translate>
						</button>
					</div>
					<div v-else-if="checkoutType === 'wallet'">
						<app-loading
							v-if="!calculatedAddressTax && valid"
							class="loading-centered"
							:label="$gettext( 'Calculating tax...' )"
							/>

						<p
							v-if="calculatedAddressTax && addressTaxAmount > 0"
							class="anim-fade-in small"
							>
							+{{ addressTaxAmount | currency }}
							<translate>tax</translate>
							<span v-app-tooltip="$gettext( `We are required to collect taxes on orders for certain regions.` )">
								<app-jolticon class="text-muted" icon="help-circle" />
							</span>
						</p>

						<div v-if="!hasSufficientWalletFunds" class="alert alert-info">
							<translate>You do not have enough funds in your Wallet for this order.</translate>
						</div>

						<button
							class="btn btn-success-outline"
							:disabled="!valid || !calculatedAddressTax || !hasSufficientWalletFunds"
							@click.prevent="checkoutWallet"
							>
							<app-jolticon icon="chevron-right" />
							<translate>Buy Using Wallet</translate>
							<small class="text-muted" v-if="calculatedAddressTax">
								{{ formModel.amount + addressTaxAmount | currency }}
							</small>
						</button>
					</div>
				</div>

			</template>
		</app-loading-fade>
	</template>

</app-form>
